# Claude Code Sandbox - Docker Compose mode
#
# Usage:
#   docker compose up -d
#   docker compose exec agent zsh
#   # Run claude inside the container
#   docker compose down
#
# For reproducibility, pin to a specific digest:
#   image: ghcr.io/mattolson/agent-sandbox-claude@sha256:<digest>
#
# For local development:
#   image: agent-sandbox-claude:local

services:
  proxy:
    build: ./images/proxy
    container_name: agent-sandbox-proxy
    volumes:
      - proxy-state:/home/mitmproxy/.mitmproxy
      - proxy-ca:/ca-export
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8080"]
      interval: 5s
      timeout: 3s
      retries: 3

  agent:
    image: agent-sandbox-claude:local
    container_name: agent-sandbox
    depends_on:
      proxy:
        condition: service_healthy
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      # Your project workspace
      - .:/workspace
      # Persist Claude credentials
      - claude-state:/home/dev/.claude
      # Persist shell history
      - claude-history:/commandhistory
      # Proxy CA certificate for HTTPS interception (public cert only, no private key)
      - proxy-ca:/etc/mitmproxy:ro
      # Host Claude config (optional - comment out if not needed)
      - ${HOME}/.claude/CLAUDE.md:/home/dev/.claude/CLAUDE.md:ro
      - ${HOME}/.claude/settings.json:/home/dev/.claude/settings.json:ro
      # To customize network policy, uncomment and create the file:
      # - ${HOME}/.config/agent-sandbox/policy.yaml:/etc/agent-sandbox/policy.yaml:ro
      # Shell customizations (optional - uncomment to enable)
      - ${HOME}/.config/agent-sandbox/shell.d:/home/dev/.config/agent-sandbox/shell.d:ro
      # Dotfiles directory (optional - use with shell.d script to symlink)
      # - ${HOME}/.dotfiles:/home/dev/.dotfiles:ro
    working_dir: /workspace
    stdin_open: true
    tty: true
    environment:
      - TZ=${TZ:-America/Los_Angeles}
      - CLAUDE_CONFIG_DIR=/home/dev/.claude
      # Proxy configuration for traffic logging
      - HTTP_PROXY=http://proxy:8080
      - HTTPS_PROXY=http://proxy:8080
      - NO_PROXY=localhost,127.0.0.1,proxy

volumes:
  claude-state:
  claude-history:
  proxy-state:
  proxy-ca:
